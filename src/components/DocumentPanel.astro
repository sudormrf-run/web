---
/**
 * DocumentPanel Component
 * Shows selected document info with connected documents
 * Desktop: Right sidebar panel
 * Mobile: Bottom sheet (slides up on selection)
 */

export interface Props {
  locale?: 'ko' | 'en';
}

const { locale = 'ko' } = Astro.props;

const labels = {
  ko: {
    selectPrompt: '노드를 선택하면 문서 정보가 여기에 표시됩니다.',
    connections: '연결된 문서',
    readDocument: '문서 읽기',
    close: '닫기',
  },
  en: {
    selectPrompt: 'Select a node to view document details here.',
    connections: 'Connected Documents',
    readDocument: 'Read Document',
    close: 'Close',
  },
};

const t = labels[locale];
---

<!-- Desktop Panel -->
<aside class="document-panel desktop-panel" id="documentPanel">
  <div class="panel-empty" id="panelEmpty">
    <div class="empty-icon">
      <svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
      </svg>
    </div>
    <p class="empty-text">{t.selectPrompt}</p>
  </div>

  <div class="panel-content" id="panelContent" style="display: none;">
    <header class="panel-header">
      <span class="panel-category" id="panelCategory"></span>
      <h2 class="panel-title" id="panelTitle"></h2>
    </header>

    <p class="panel-description" id="panelDescription"></p>

    <div class="panel-tags" id="panelTags"></div>

    <div class="panel-connections">
      <h3 class="connections-title">
        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
        </svg>
        {t.connections}
        <span class="connections-count" id="connectionsCount"></span>
      </h3>
      <ul class="connections-list" id="connectionsList"></ul>
    </div>

    <a class="panel-action" id="panelAction" href="#">
      <span>{t.readDocument}</span>
      <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" />
      </svg>
    </a>
  </div>
</aside>

<!-- Mobile Bottom Sheet -->
<div class="bottom-sheet-overlay" id="sheetOverlay"></div>
<aside class="bottom-sheet" id="bottomSheet">
  <div class="sheet-handle" id="sheetHandle">
    <span class="handle-bar"></span>
  </div>

  <div class="sheet-content">
    <header class="sheet-header">
      <div class="sheet-header-info">
        <span class="panel-category" id="sheetCategory"></span>
        <h2 class="panel-title" id="sheetTitle"></h2>
      </div>
      <button class="sheet-close" id="sheetClose" aria-label={t.close}>
        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </header>

    <p class="sheet-description" id="sheetDescription"></p>

    <div class="sheet-tags" id="sheetTags"></div>

    <div class="sheet-connections">
      <h3 class="connections-title">
        <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
        </svg>
        {t.connections}
        <span class="connections-count" id="sheetConnectionsCount"></span>
      </h3>
      <div class="connections-scroll">
        <ul class="connections-list" id="sheetConnectionsList"></ul>
      </div>
    </div>

    <a class="sheet-action" id="sheetAction" href="#">
      <span>{t.readDocument}</span>
      <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" />
      </svg>
    </a>
  </div>
</aside>

<script>
  // Category color mapping
  const categoryColors: Record<string, string> = {
    essays: '#eab308',
    models: '#3b82f6',
    companies: '#10b981',
    hardware: '#a78bfa',
    people: '#f472b6',
  };

  const categoryLabels: Record<string, Record<string, string>> = {
    ko: {
      essays: '에세이',
      models: '모델',
      companies: '기업',
      hardware: '하드웨어',
      people: '인물',
    },
    en: {
      essays: 'Essay',
      models: 'Model',
      companies: 'Company',
      hardware: 'Hardware',
      people: 'People',
    },
  };

  // Get locale from document
  const locale = document.documentElement.lang === 'en' ? 'en' : 'ko';

  // Desktop elements
  const panel = document.getElementById('documentPanel');
  const panelEmpty = document.getElementById('panelEmpty');
  const panelContent = document.getElementById('panelContent');
  const panelCategory = document.getElementById('panelCategory');
  const panelTitle = document.getElementById('panelTitle');
  const panelTags = document.getElementById('panelTags');
  const panelDescription = document.getElementById('panelDescription');
  const connectionsCount = document.getElementById('connectionsCount');
  const connectionsList = document.getElementById('connectionsList');
  const panelAction = document.getElementById('panelAction') as HTMLAnchorElement;

  // Mobile elements
  const sheetOverlay = document.getElementById('sheetOverlay');
  const bottomSheet = document.getElementById('bottomSheet');
  const sheetHandle = document.getElementById('sheetHandle');
  const sheetClose = document.getElementById('sheetClose');
  const sheetCategory = document.getElementById('sheetCategory');
  const sheetTitle = document.getElementById('sheetTitle');
  const sheetTags = document.getElementById('sheetTags');
  const sheetDescription = document.getElementById('sheetDescription');
  const sheetConnectionsCount = document.getElementById('sheetConnectionsCount');
  const sheetConnectionsList = document.getElementById('sheetConnectionsList');
  const sheetAction = document.getElementById('sheetAction') as HTMLAnchorElement;

  // Check if mobile
  const isMobile = () => window.innerWidth < 1024;

  // Close sheet
  function closeSheet() {
    bottomSheet?.classList.remove('open');
    sheetOverlay?.classList.remove('show');
    document.body.style.overflow = '';
  }

  // Open sheet
  function openSheet() {
    bottomSheet?.classList.add('open');
    sheetOverlay?.classList.add('show');
    document.body.style.overflow = 'hidden';
  }

  // Update panel with node data
  function updatePanel(node: any, connectedNodes: any[]) {
    if (!node) {
      // Clear panel
      if (panelEmpty) panelEmpty.style.display = 'flex';
      if (panelContent) panelContent.style.display = 'none';
      closeSheet();
      return;
    }

    const category = node.category || 'document';
    const categoryLabel = categoryLabels[locale]?.[category] || category;
    const categoryColor = categoryColors[category] || '#6b7280';

    // Render tags HTML with # prefix and border style
    const tagsHtml = (node.tags || [])
      .map((tag: string) => `<button class="tag-btn" data-tag="${tag}">#${tag}</button>`)
      .join('');

    // Render connections HTML (exclude self)
    const otherNodes = connectedNodes.filter(n => n.id !== node.id);
    const connectionsHtml = otherNodes
      .map((n: any) => {
        const color = categoryColors[n.category] || '#6b7280';
        return `
          <li>
            <button class="connection-btn" data-node-id="${n.id}">
              <span class="connection-dot" style="background: ${color}"></span>
              <span class="connection-label">${n.label}</span>
            </button>
          </li>
        `;
      })
      .join('');

    // Update desktop panel
    if (panelEmpty) panelEmpty.style.display = 'none';
    if (panelContent) panelContent.style.display = 'block';
    if (panelCategory) {
      panelCategory.textContent = categoryLabel;
      panelCategory.style.color = categoryColor;
    }
    if (panelTitle) panelTitle.textContent = node.label;
    if (panelTags) panelTags.innerHTML = tagsHtml;
    if (panelDescription) panelDescription.textContent = node.description || '';
    if (connectionsCount) connectionsCount.textContent = `(${otherNodes.length})`;
    if (connectionsList) connectionsList.innerHTML = connectionsHtml;
    if (panelAction && node.url) {
      panelAction.href = node.url;
      panelAction.style.backgroundColor = categoryColor;
    }

    // Update mobile sheet
    if (sheetCategory) {
      sheetCategory.textContent = categoryLabel;
      sheetCategory.style.color = categoryColor;
    }
    if (sheetTitle) sheetTitle.textContent = node.label;
    if (sheetTags) sheetTags.innerHTML = tagsHtml;
    if (sheetDescription) sheetDescription.textContent = node.description || '';
    if (sheetConnectionsCount) sheetConnectionsCount.textContent = `(${otherNodes.length})`;
    if (sheetConnectionsList) sheetConnectionsList.innerHTML = connectionsHtml;
    if (sheetAction && node.url) {
      sheetAction.href = node.url;
      sheetAction.style.backgroundColor = categoryColor;
    }

    // Open sheet on mobile
    if (isMobile()) {
      openSheet();
    }
  }

  // Listen for graph events
  document.addEventListener('graph:node-select', ((e: CustomEvent) => {
    updatePanel(e.detail.node, e.detail.connectedNodes);
  }) as EventListener);

  // Connection click handler (delegate) - dispatch event only, let parent handle reset
  document.addEventListener('click', (e) => {
    const target = e.target as HTMLElement;
    const connectionBtn = target.closest('.connection-btn');

    if (connectionBtn) {
      const nodeId = connectionBtn.getAttribute('data-node-id');
      if (nodeId) {
        // Dispatch event - parent (browse.astro) will handle reset and focus
        document.dispatchEvent(new CustomEvent('panel:focus-node', {
          detail: { nodeId }
        }));
      }
    }

    // Tag click handler - dispatch event only, let parent handle reset
    const tagBtn = target.closest('.tag-btn');
    if (tagBtn) {
      const tag = tagBtn.getAttribute('data-tag');
      if (tag) {
        document.dispatchEvent(new CustomEvent('panel:filter-tag', {
          detail: { tag }
        }));
      }
    }
  });

  // Sheet close handlers
  sheetClose?.addEventListener('click', closeSheet);
  sheetOverlay?.addEventListener('click', closeSheet);

  // Sheet drag to close
  let startY = 0;
  let currentY = 0;

  sheetHandle?.addEventListener('touchstart', (e) => {
    startY = e.touches[0].clientY;
  });

  sheetHandle?.addEventListener('touchmove', (e) => {
    currentY = e.touches[0].clientY;
    const diff = currentY - startY;

    if (diff > 0) {
      bottomSheet!.style.transform = `translateY(${diff}px)`;
    }
  });

  sheetHandle?.addEventListener('touchend', () => {
    const diff = currentY - startY;

    if (diff > 100) {
      closeSheet();
    }

    bottomSheet!.style.transform = '';
    startY = 0;
    currentY = 0;
  });
</script>

<style>
  /* Desktop Panel */
  .desktop-panel {
    display: none;
    flex-direction: column;
    height: 100%;
    background: var(--color-bg-primary, #0a0a0f);
    border-left: 1px solid var(--color-border, #333);
    overflow-y: auto;
  }

  @media (min-width: 1024px) {
    .desktop-panel {
      display: flex;
    }
  }

  .panel-empty {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    padding: 2rem;
    text-align: center;
  }

  .empty-icon {
    color: var(--color-text-muted, #555);
    margin-bottom: 1rem;
  }

  .empty-text {
    color: var(--color-text-muted, #888);
    font-size: 0.875rem;
    line-height: 1.5;
    max-width: 200px;
  }

  .panel-content {
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .panel-header {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .panel-category {
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .panel-title {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--color-text-primary, #fff);
    line-height: 1.3;
    margin: 0;
  }

  .panel-tags,
  .sheet-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 0.5rem;
    padding-top: 0.75rem;
    border-top: 1px solid var(--color-border, #333);
  }

  /* :global() is needed because tags are dynamically rendered via innerHTML */
  :global(.tag-btn) {
    padding: 0.375rem 0.625rem;
    background: transparent;
    border: 1px solid var(--color-border, #555);
    border-radius: var(--radius-sm, 6px);
    color: var(--color-text-muted, #999);
    font-size: 0.75rem;
    font-family: 'JetBrains Mono', monospace;
    cursor: pointer;
    transition: all 0.15s ease;
  }

  :global(.tag-btn:hover) {
    background: var(--color-bg-tertiary, #252530);
    border-color: var(--color-accent, #3b82f6);
    color: var(--color-accent, #3b82f6);
  }

  :global(.tag-btn:active) {
    background: var(--color-accent, #3b82f6);
    border-color: var(--color-accent, #3b82f6);
    color: white;
    transform: scale(0.95);
  }

  .panel-action,
  .sheet-action {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    background: var(--color-accent, #3b82f6);
    color: white;
    border-radius: var(--radius-md, 8px);
    text-decoration: none;
    font-size: 0.875rem;
    font-weight: 600;
    transition: all 0.2s ease;
    margin-top: 1.5rem;
  }

  .panel-action:hover,
  .sheet-action:hover {
    filter: brightness(1.1);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  }

  .panel-action:active,
  .sheet-action:active {
    transform: translateY(0);
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
  }

  .panel-description,
  .sheet-description {
    font-size: 0.875rem;
    color: var(--color-text-secondary, #aaa);
    line-height: 1.6;
  }

  .panel-connections,
  .sheet-connections {
    flex: 1;
    min-height: 0;
    margin-top: 0.75rem;
    padding-top: 1rem;
    border-top: 1px solid var(--color-border, #333);
  }

  .connections-title {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.8rem;
    font-weight: 600;
    color: var(--color-text-secondary, #aaa);
    margin: 0 0 0.75rem;
  }

  .connections-count {
    color: var(--color-text-muted, #666);
    font-weight: 400;
  }

  .connections-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  /* :global() for dynamically rendered connection buttons */
  :global(.connection-btn) {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    width: 100%;
    padding: 0.5rem 0.75rem;
    background: var(--color-bg-secondary, #1a1a1f);
    border: 1px solid var(--color-border, #333);
    border-radius: var(--radius-sm, 6px);
    cursor: pointer;
    transition: all 0.15s;
    text-align: left;
  }

  :global(.connection-btn:hover) {
    border-color: var(--color-accent, #3b82f6);
    background: var(--color-bg-tertiary, #252530);
  }

  :global(.connection-dot) {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  :global(.connection-label) {
    font-size: 0.8rem;
    color: var(--color-text-primary, #fff);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  /* Bottom Sheet (Mobile) */
  .bottom-sheet-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 200;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s, visibility 0.3s;
  }

  .bottom-sheet-overlay.show {
    opacity: 1;
    visibility: visible;
  }

  .bottom-sheet {
    display: none;
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    max-height: 70vh;
    background: var(--color-bg-primary, #0a0a0f);
    border-top-left-radius: var(--radius-xl, 16px);
    border-top-right-radius: var(--radius-xl, 16px);
    z-index: 250;
    transform: translateY(100%);
    transition: transform 0.3s ease-out;
  }

  .bottom-sheet.open {
    transform: translateY(0);
  }

  @media (max-width: 1023px) {
    .bottom-sheet-overlay,
    .bottom-sheet {
      display: block;
    }
  }

  .sheet-handle {
    display: flex;
    justify-content: center;
    padding: 0.75rem;
    cursor: grab;
  }

  .handle-bar {
    width: 36px;
    height: 4px;
    background: var(--color-border, #333);
    border-radius: 2px;
  }

  .sheet-content {
    padding: 0 1.5rem 1.5rem;
    max-height: calc(70vh - 40px);
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .sheet-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 1rem;
  }

  .sheet-header-info {
    flex: 1;
    min-width: 0;
  }

  .sheet-close {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    background: var(--color-bg-secondary, #1a1a1f);
    border: 1px solid var(--color-border, #333);
    border-radius: var(--radius-sm, 6px);
    color: var(--color-text-muted, #888);
    cursor: pointer;
    flex-shrink: 0;
  }

  .sheet-close:hover {
    color: var(--color-text-primary, #fff);
  }

  .connections-scroll {
    max-height: 150px;
    overflow-y: auto;
  }
</style>
